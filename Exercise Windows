#sent_month, id_account, sent_msg_percent_from_this_month, first_sent_date, last_sent_date

#MIN(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER (PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH))


#скажите почему надо переносит  first_sent_date, last_sent_date      в пидзапит, якщо працюе и так? Чи резултат буде всеж таки инакший?

select 
        distinct date_trunc(aa.ndate, month) as sent_month ,
        account_id,
        cnt_acc/cnt_month*100 as sent_msg_percent_from_this_month,  
        first_sent_date,   
        last_sent_date   
        #скажите почему надо переносит  first_sent_date, last_sent_date  в пидзапит, якщо працюе и так... Чи резултат буде всеж таки инакший?
        #min(ndate) as first_sent_date,        
        #max(ndate) as last_sent_date,        
from (
select 
        DATE_ADD(s.date, INTERVAL es.sent_date day) as ndate,
        es.id_account as account_id,
        count(es.id_message) OVER (PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) as cnt_acc,
        count(es.id_message) over (partition by DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) as cnt_month,
        MIN(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER (PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH))as first_sent_date,
        MAX(DATE_ADD(s.date, INTERVAL es.sent_date DAY)) OVER (PARTITION BY es.id_account, DATE_TRUNC(DATE_ADD(s.date, INTERVAL es.sent_date DAY), MONTH)) as last_sent_date,
        es.id_message,
from `DA.email_sent` es
join `DA.account_session` acs
on acs.account_id = es.id_account
join `DA.session` s
on s.ga_session_id = acs.ga_session_id
)aa
#where account_id = 656921
#group by 1,2,3
order by 1 desc
